{% extends 'base.html' %}
{% load staticfiles %}
{% load crispy_forms_tags %}

{% block title %}Google Sig-in{% endblock %}

{% block page_title %}
    Google Plus Sign-in
{% endblock %}
{% block description %}
    Testing to see how Google+ works so that I can use for logging users in before they comment
{% endblock %}

{% block extra_js_in_header %}
    <!-- Configuration options in <meta /> elements a single time to be used by 
            HTML widgets/js for any sign-in buttons or interactive post buttons.-->
    <meta name="google-signin-clientid" content="436904769980-46s5h10ckh8acf5337m1an3fiko7du3g.apps.googleusercontent.com" />
    <meta name="google-signin-scope" content="https://www.googleapis.com/auth/plus.login" />
    <meta name="google-signin-requestvisibleactions" content="http://schema.org/AddAction" />
    <meta name="google-signin-cookiepolicy" content="single_host_origin" />
    <meta name="google-signin-callback" content="render" />
    <meta name="google-signin-accesstype" content="offline" />
    <meta name="google-signin-redirecturi" content = "postmessage" />
    <meta name="google-signin-approvalprompt content = "prompt" />
    
    <!-- The Google Javascript library required for Google+ Sign-in button -->
    <script src="https://apis.google.com/js/client:platform.js" async defer></script>
    
    <!-- Inititate the Google+ Sign-in workflow and handle the server response -->
    <script type = "text/javascript">
        function signInCallback(authResult) {
            if (authResult['code']) {
                
                // Hide the sign-in button now that the user is authorized, for example:
                $('#signinButton').attr('style', 'display: none');
                
                // Send the code to the server
                $.post( "{% url 'google_sign_in' %}", {'code': authResult['code']} )
                    .done(function( data ) {
                        console.log( "Data Loaded: " + data );
                        console.log("one-time code: " + authResult['code']);
                        console.log("id_token: "  + authResult['id_token'] );
                        console.log("access_token: " + authResult['access_token']);
                        console.log("expires_in: " + authResult['expires_in']);
                        console.log("authuser: " + authResult['authuser']);
                        console.log("google_logged_in: " + authResult['status']['google_logged_in']);
                        console.log("method: " + authResult['status']['method']);
                        console.log("signed_in: " + authResult['status']['signed_in']);
                    });
            } else if (authResult['error']) {
                /** 
                    Possible error codes:
                        "access_denied" - User denied access to your app.
                        "immediate_failed" - Could not automatically log in the user
                 */
                console.log('error: ' + authResult['error']);
                console.log('authResult: ' + authResult['error_description']);
            }
        }
    
        /* Executed when the APIs finish loading */
        function render() {

            // The only additional params is the callback, the rest of the params will
            // come from the page-level configuration.
            var additionalParams = {
                'callback': signInCallback
            };

            // Attach a click listener to a button to trigger the flow.
            var signinButton = document.getElementById('signinButton');
            signinButton.addEventListener('click', function() {
                gapi.auth.signIn(additionalParams); // Will use page level configuration
            });
        }
    </script>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-12">
            <!-- Add where you want your sign-in button to render -->
            <div id="signinButton">
                <span class="g-signin"></span>
            </div>

            <div id="result"></div>
        </div>
    </div>
{% endblock %}